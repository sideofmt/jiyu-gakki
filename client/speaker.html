<!doctype html>
<html lang="ja" ng-app>
  <head>
    <title>Sound play</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/bootstrap-responsive.min.css">
    <link rel="stylesheet" href="/css/speaker.css">
    <script>
    
      try{
          window.AudioContext = window.AudioContext || window.webkitAudioContext;
          // Create the instance of AudioContext
          context = new AudioContext();
          //master = context.createGain();
          //master.connect(context.destination);
          console.info("AudioContext is created");
          
      }
      catch(e) {
          alert('Web Audio API is not supported in this browser');
      }
      
      var table = new Array();
      for(var i=0; i<128; i++){
        table.push(440.0 * Math.pow(2, (i-70)/12));
      }
        
      var MtoF = function(noteNumber){
        return table[noteNumber];
      };
      
    var master = context.createGain();
    master.connect(context.destination);

    
    var oscs = new Map();
    
    
      function init(){
        var socket = io.connect();
        
        //var melody_list = [];
        var ctrls = new Map();
        
        
        socket.on('connect', function(msg){
          socket.headbeatTimeout = 5000;
        });
        
        socket.on('greeting', function(data){
          console.log(data);
          socket.emit('greeting', "this is speaker");
        });
        
        socket.on('add_ctrl',function(id){
          console.log("add controller ID:"+id);
          var map = new Map()
          ctrls.set(id, map);
        });
        
        socket.on('cut_ctrl',function(id){
          console.log("cut controller ID:"+id);
          ctrls.delete(id);
        });
        
        
        socket.on('sendNoteOn',function(msg){
          console.log("noteOn catch ID:" +msg[0] + " touchID:"+msg[1] + " key:"+msg[2]);
          
          var socketid = msg[0];
          var touchid = msg[1];
          var key = msg[2];
          
          var gain = context.createGain();
			    var osc = context.createOscillator();
    			osc.connect(gain);
    			gain.connect(master);
    			osc.type = 'square';
          osc.frequency.value = MtoF(key);
          gain.gain.value = 0.5;
    			osc.start();
    			

    		  oscs.set(socketid+touchid,osc);
    			console.log(oscs);
        });
        
        socket.on('sendNoteChange',function(msg){
          
          console.log("noteChange catch ID:" +msg[0] + " touchID:"+msg[1] + " key:"+msg[2]);
          
          var socketid = msg[0];
          var touchid = msg[1];
          var key = msg[2];
  
          
          console.log(oscs);
          oscs.get(socketid+touchid).frequency.value = MtoF(key);
          
        });
        
        socket.on('sendNoteOff',function(msg){
          
          console.log("noteOff catch ID:" +msg[0] + " touchID:"+msg[1] + " key:"+msg[2]);
          
          var socketid = msg[0];
          var touchid = msg[1];
          var key = msg[2];
          
				  oscs.get(socketid+touchid).stop();
				  oscs.delete(socketid+touchid);
          
        });
        
        
        
      };
      
      if(window.addEventListener){
        window.addEventListener('load',init);
      }else if(window.attachEvent){
        window.attachEvent('onload',init);
      }
      
      
      
      
      
      
      
      
      
      

      
      
      
      
      
      
      
      
      
    </script>
  </head>
  <body>
    <div class="container">
      <div class="navbar navbar-fixed-top navbar-inverse">
        <div class="navbar-inner">
          <div class="pull-right">
            <a href="#" class="brand">CPS</a>
          </div>
        </div>
      </div>
    </div>
    
    <img src="/img/QRcode-2.gif" align="center" class="QR">
    <h3 align="center">このQRコードのリンク先に飛んで画面に触れるとこのPCから音がなります</h3>
    
    
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/angular.min.js"></script>
    <script src="/js/visualize.js"></script>
    
    
  </body>
</html>
